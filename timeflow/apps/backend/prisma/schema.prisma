generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String   @id @default(cuid())
  email                   String   @unique
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Google integration
  googleId                String?  @unique
  googleRefreshToken      String?
  googleAccessToken       String?
  googleAccessTokenExpiry DateTime?

  // Preferences
  timeZone                 String  @default("America/Chicago")
  wakeTime                 String  @default("08:00") // "HH:mm" - Default for all days
  sleepTime                String  @default("23:00") // "HH:mm" - Default for all days
  dailySchedule            Json?   // Per-day wake/sleep times: { monday: { wakeTime, sleepTime }, ... }
  defaultTaskDurationMinutes Int   @default(30)
  defaultCalendarId        String?

  tasks           Task[]
  categories      Category[]
  habits          Habit[]
  scheduledHabits ScheduledHabit[]
  appliedSchedules AppliedSchedule[]
  conversations   Conversation[]
  emailCategoryConfigs EmailCategoryConfig[]
}

model Task {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])

  title           String
  description     String?
  durationMinutes Int      @default(30)
  priority        Int      @default(2) // 1 = high, 2 = medium, 3 = low
  status          String   @default("unscheduled") // unscheduled | scheduled | completed

  categoryId      String?
  category        Category? @relation(fields: [categoryId], references: [id])

  dueDate         DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  scheduledTask   ScheduledTask?
}

model ScheduledTask {
  id                String   @id @default(cuid())
  taskId            String   @unique
  task              Task     @relation(fields: [taskId], references: [id])

  provider          String   // "google" | "apple"
  calendarId        String
  eventId           String

  startDateTime     DateTime
  endDateTime       DateTime

  overflowedDeadline Boolean @default(false)
  lastSyncedAt      DateTime @default(now())
}

model Category {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  name      String
  color     String   // hex color code, e.g., "#3B82F6"
  isDefault Boolean  @default(false)
  order     Int      @default(0)

  tasks     Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

model Habit {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  title       String
  description String?

  // Frequency settings
  frequency   String   // "daily" | "weekly" | "custom"
  daysOfWeek  String[] // ["mon", "tue", "wed"] for weekly habits

  // Time preferences
  preferredTimeOfDay String?  // "morning" | "afternoon" | "evening" | null
  durationMinutes    Int      @default(30)

  // Status
  isActive    Boolean  @default(true)

  scheduledHabits ScheduledHabit[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model ScheduledHabit {
  id              String   @id @default(cuid())
  habitId         String
  habit           Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id])

  // Calendar integration
  provider        String   // "google" | "apple"
  calendarId      String
  eventId         String

  // Scheduled time
  startDateTime   DateTime
  endDateTime     DateTime

  // Metadata
  status          String   @default("scheduled") // "scheduled" | "completed" | "skipped"
  lastSyncedAt    DateTime @default(now())

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([habitId])
  @@index([userId])
}

model AppliedSchedule {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  requestHash    String
  blocks         Json
  tasksScheduled Int
  habitsScheduled Int
  createdAt      DateTime @default(now())

  @@unique([userId, requestHash])
  @@index([userId])
}

model Conversation {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  title     String?  // Optional user-provided title (e.g., "Monday Planning")
  isPinned  Boolean  @default(false)

  messages  ConversationMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, updatedAt])
}

model ConversationMessage {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role      String   // "user" | "assistant"
  content   String   @db.Text
  metadata  Json?    // Store mascotState, schedulePreview, etc.

  createdAt DateTime @default(now())

  @@index([conversationId])
}

model EmailCategoryConfig {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  categoryId  String   // matches EmailCategory union (e.g., "work", "personal")
  color       String?
  enabled     Boolean  @default(true)
  name        String?
  description String?
  emoji       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, categoryId])
  @@index([userId])
}
